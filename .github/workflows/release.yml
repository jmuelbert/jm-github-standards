---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2026-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@gmail.com>

name: Release
on:
  push:
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.generate-token.outputs.token }}
      next_version: ${{ steps.get-version.outputs.version }}
      is_prerelease: ${{ steps.get-version.outputs.prerelease }}
    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: ðŸ”‘ Generate Token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.1.1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - name: ðŸ·ï¸ Get Config from YAML
        id: get-version
        run: |
          # Extract version
          META_FILE=".github/repo-metadata.yml"

          if [ -f "$META_FILE" ]; then
            VERSION="$(grep 'next_release:'" "$META_FILE" | awk '{print $2}' | tr -d '"')"
            # Pre-release: Extract status (true/false)
            PRERELEASE="$(grep 'is-prerelease:' "$META_FILE" | awk '{print $2}')"

            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Metadata file not found at $META_FILE"
            exit 1
          fi

  # Job 2: Call Shared Workflow
  call-release:
    needs: prepare # Wait for the first job
    permissions:
      contents: write
      id-token: write
    uses: jmuelbert/jm-github-standards/.github/workflows/shared-release-generic.yml@main
    with:
      profile: generic
      token: ${{ needs.prepare.outputs.token }}
      # Here you can pass inputs if needed
      # version: ${{ needs.prepare.outputs.next_version }}
      # build_command: make build
    secrets:
      # The token is passed from the first job
      RELEASE_TOKEN: ${{ needs.prepare.outputs.token }}
