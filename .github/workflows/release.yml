---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2026-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@gmail.com>

name: Release
on:
  push:
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      next_version: ${{ steps.get-version.outputs.version }}
      is_prerelease: ${{ steps.get-version.outputs.prerelease }}
    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: ðŸ·ï¸ Get Config from YAML
        id: get-version
        run: |
          # Extract version
          META_FILE=".github/repo-metadata.yml"

          if [ -f "$META_FILE" ]; then
            VERSION=$(grep "next_release:" "$META_FILE" | awk '{print $2}' | tr -d '"' | tr -d "'")
            PRERELEASE=$(grep "is-prerelease:" "$META_FILE" | awk '{print $2}')

            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Metadata file not found at $META_FILE"
            exit 1
          fi

  # Job 2: Call Shared Workflow
  call-release:
    needs: prepare # Wait for the first job
    permissions:
      contents: write
      id-token: write
    uses: jmuelbert/jm-github-standards/.github/workflows/shared-release-generic.yml@main
    with:
      profile: generic
      is_prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
    secrets:
      # Get the basic data to the shared workflow
      RELEASE_APP_ID: ${{ secrets.RELEASE_APP_ID }}
      RELEASE_APP_PRIVATE_KEY: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
