---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2026-present J√ºrgen M√ºlbert <juergen.muelbert@gmail.com>

name: Shared Generic Reusable Release

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      profile:
        required: true
        type: string
        description: Language profile (e.g. node, python, generic)
      is_prerelease:
        type: boolean
        default: false
        description: "Is this a pre-release?"
      doc_command:
        type: string
        default: ""
        description: Command to deploy documentation
    secrets:
      RELEASE_APP_ID:
        required: true
      RELEASE_APP_PRIVATE_KEY:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: üîí Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: üîë Generate Token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.1.1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - name: üß∞ Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: üìù Prepare Release Config
        run: |
          if [ -f ".github/config/base.releaserc.json" ]; then
            cp .github/config/base.releaserc.json .releaserc.json
            echo "‚úÖ Config copied to root"
          else
            echo "::error::Release config not found!"
            exit 1
          fi

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@f80bc733841d90bfa72e388034af6153a9c4e4cc # v6.0.0
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            conventional-changelog-conventionalcommits
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: üîß Install Astral uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          enable-cache: true

      - name: üè∑Ô∏è Update Floating Tags (Dynamic)
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          # 1. Version aus dem Release extrahieren (z.B. 0.1.7)
          VERSION="${{ steps.semantic.outputs.new_release_version }}"
          echo "Processing tags for version: v$VERSION"

          # 2. Major (v0) und Minor (v0.1) berechnen
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f1,2)

          # 3. Git Identit√§t setzen (f√ºr den lokalen Tag-Befehl)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 4. Tags lokal forcieren
          git tag -f "v$MAJOR"
          git tag -f "v$MINOR"

          # 5. Tags mit Force zu GitHub schieben
          echo "Pushing floating tags v$MAJOR and v$MINOR..."
          git push origin "v$MAJOR" --force
          git push origin "v$MINOR" --force
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: üìö Deploy Documentation
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          if [ -f "mkdocs.yml" ]; then
            if [ "${{ inputs.is_prerelease }}" = "true" ]; then
              ALIAS="preview"
              MIKE_OPTS=""
            else
              ALIAS="latest"
              MIKE_OPTS="--set-default"
            fi

            echo "üöÄ Deploying version ${{ steps.semantic.outputs.new_release_version }} as $ALIAS"

            uv run --with mkdocs-material --with mike \
              mike deploy --push --update-aliases $MIKE_OPTS \
              "${{ steps.semantic.outputs.new_release_version }}" "$ALIAS"
          fi

      - name: üìö Deploy Specific Documentation
        if: steps.semantic.outputs.new_release_published == 'true' && inputs.doc_command != ''
        run: ${{ inputs.doc_command }}
