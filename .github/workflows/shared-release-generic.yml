---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2026-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@gmail.com>

name: Shared Generic Reusable Release

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      profile:
        required: true
        type: string
        description: Language profile (e.g. node, python, generic)
      is_prerelease:
        type: boolean
        default: false
        description: "Is this a pre-release?"
      doc_command:
        type: string
        default: ""
        description: Command to deploy documentation
    secrets:
      RELEASE_APP_ID:
        required: true
      RELEASE_APP_PRIVATE_KEY:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ğŸ”’ Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: ğŸ”‘ Generate Token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.1.1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: ğŸ“ Prepare Release Config
        run: |
          if [ -f ".github/config/base.releaserc.json" ]; then
            cp .github/config/base.releaserc.json .releaserc.json
            echo "âœ… Config copied to root"
          else
            echo "::error::Release config not found!"
            exit 1
          fi

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@1c8dbaa298552ad40802cf44320879943de90278 # v6.0.0
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            conventional-changelog-conventionalcommits
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: ğŸ”§ Install Astral uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true

      - name: ğŸ“š Deploy Documentation
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          if [ -f "mkdocs.yml" ]; then
            if [ "${{ inputs.is_prerelease }}" = "true" ]; then
              ALIAS="preview"
              MIKE_OPTS=""
            else
              ALIAS="latest"
              MIKE_OPTS="--set-default"
            fi

            echo "ğŸš€ Deploying version ${{ steps.semantic.outputs.new_release_version }} as $ALIAS"

            uv run --with mkdocs-material --with mike \
              mike deploy --push --update-aliases $MIKE_OPTS \
              "${{ steps.semantic.outputs.new_release_version }}" "$ALIAS"
          fi

      - name: ğŸ“š Deploy Specific Documentation
        if: steps.semantic.outputs.new_release_published == 'true' && inputs.doc_command != ''
        run: ${{ inputs.doc_command }}
