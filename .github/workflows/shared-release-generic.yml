---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2025-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@gmail.com>

name: Reusable Release

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      profile:
        required: true
        type: string
        description: Language profile (e.g. node, python, generic)
      doc_command:
        type: string
        default: ""
        description: Command to deploy documentation
    secrets:
      RELEASE_TOKEN:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@f80bc733841d90bfa72e388034af6153a9c4e4cc # v6.0.0
        with:
          extends: |
            ./.github/config/base.releaserc.json
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            ${{ inputs.profile == 'node' && '@semantic-release/npm' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: ðŸ”§ Install Astral uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          enable-cache: true

      - name: ðŸ“š Deploy Documentation
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          if [ -f "mkdocs.yml" ]; then
            uv run --with mkdocs-material --with mike \
              mike deploy --push --update-aliases ${{ steps.semantic.outputs.new_release_version }} latest
          fi

      - name: ðŸ“š Deploy Specific Documentation
        if: steps.semantic.outputs.new_release_published == 'true' && inputs.doc_command != ''
        run: ${{ inputs.doc_command != '' }}
